<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Tabata Timer</title>

<!-- PWA-ish (hide browser chrome when added to Home Screen) -->
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<style>
  :root{
    --bg-work:#000;         /* page bg when WORK */
    --bg-rest:#8b1e5d;      /* page bg when REST */
    --bg-pause:#87ceeb;     /* page bg when PAUSED */

    --fg:#fff;
    --border:#23252b;
    --muted:rgba(255,255,255,.08);
    --muted2:rgba(255,255,255,.04);

    /* Text colors per mode */
    --letters-work:#60a5fa;  /* light blue labels (work) */
    --nums-rest:#facc15;     /* yellow numbers (rest) */
    --nums-pause:#a855f7;    /* purple numbers (pause) */

    /* Rising bar colors */
    --work1: rgba(34,197,94,.95);  /* green */
    --work2: rgba(34,197,94,.65);
    --rest1: rgba(239,68,68,.95);  /* red */
    --rest2: rgba(239,68,68,.65);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--fg);
    font-family:Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial;
    -webkit-tap-highlight-color:transparent;
    background:var(--bg-work);
    transition:background .18s ease;
    overflow-x:hidden;
  }

  /* Rising background bar (behind content) */
  .progress-full{
    position:fixed; left:0; right:0; bottom:0; z-index:0;
    height:6vh; /* starts small and rises toward full screen */
    background:linear-gradient(to top, var(--work1), var(--work2));
    box-shadow:0 -10px 30px rgba(34,197,94,.30);
    pointer-events:none;
    transition:background .12s ease, box-shadow .12s ease, height .15s linear;
  }

  .app{
    position:relative; z-index:1; max-width:820px; margin:0 auto;
    min-height:100%; display:flex; flex-direction:column;
    gap:10px; padding:8px 12px 92px;  /* room for footer badge */
  }

  /* VERY TOP: Work/Rest + Stopwatch */
  .meta-top{
    display:flex; align-items:center; justify-content:flex-start; gap:10px; flex-wrap:wrap;
    font-size:12px; color:#bbb; opacity:.95; padding:4px 0 2px; min-height:32px;
  }
  .meta-top .tag{
    background:var(--muted2); border:1px solid var(--border);
    border-radius:999px; padding:6px 10px; display:flex; align-items:center; gap:6px;
  }
  .meta-tags{} /* this group is hidden while playing */
  .stopwatch{display:inline-flex; align-items:center; gap:8px; padding:6px 12px; border-radius:999px;}
  .stopwatch .icon{font-size:16px; opacity:.95}
  .stopwatch b{font-size:18px; font-weight:1000; letter-spacing:.02em;}
  @media (max-width:420px){
    .stopwatch b{font-size:17px}
  }

  /* TOP-RIGHT: Big REP + info */
  .top-right{
    position:fixed; top:6px; right:8px; z-index:11; display:flex; align-items:center; gap:8px;
  }
  .rep-big{
    background:transparent; border:none; color:#fff; cursor:pointer; user-select:none;
    font-weight:1000; line-height:1; letter-spacing:.02em;
    font-size:72px; /* a bit smaller than the countdown */
    text-shadow:0 2px 10px rgba(0,0,0,.35);
  }
  .pill{
    background:var(--muted2); color:#bbb; border:1px solid var(--border);
    border-radius:999px; padding:6px 10px; font-size:12px; font-weight:800; cursor:pointer; user-select:none;
  }
  .pill:active{transform:translateY(1px)}

  /* Topbar (parts are hidden while playing) */
  .topbar{
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap
  }
  .chip{
    display:inline-flex; align-items:center; gap:8px; padding:8px 12px;
    background:var(--muted2); border:1px solid var(--border); border-radius:999px; font-size:14px
  }
  .switch{position:relative; width:56px; height:32px; background:#333; border:1px solid var(--border); border-radius:999px; cursor:pointer}
  .switch input{display:none}
  .knob{position:absolute; top:2px; left:2px; width:28px; height:28px; border-radius:50%; background:#777; transition:all .18s ease}
  .switch input:checked + .knob{left:26px; background:#34d399}
  input[type="range"]{accent-color:#34d399}

  /* Buttons */
  .btn{
    appearance:none; border:1px solid var(--border);
    background:var(--muted); color:rgba(255,255,255,.85);
    padding:12px 16px; border-radius:14px; font-weight:800; cursor:pointer; touch-action:manipulation;
    box-shadow:none;
  }
  .btn:hover{background:var(--muted2)}
  .btn:active{transform:translateY(1px)}
  .btn-xxl{font-size:22px; padding:14px 18px; border-radius:16px; min-width:150px}
  .btn.disabled{opacity:.45; filter:grayscale(.2); cursor:not-allowed}
  .btn.active{ outline:2px solid rgba(255,255,255,.12); }

  /* Big Settings button */
  .btn-settings-big{
    width:100%; max-width:220px; font-size:20px; padding:14px 16px; border-radius:14px;
    display:block; margin-top:8px;
  }

  /* Screens */
  .screen{display:none}
  .screen.active{display:block}

  /* Timer layout */
  .timer{ text-align:center; padding:0 6px}
  .midwrap{
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    min-height:56vh;
  }
  .pause-banner{
    display:none; font-size:48px; font-weight:1000; letter-spacing:.12em;
    text-transform:uppercase; color:var(--nums-pause);
    text-shadow:0 2px 14px rgba(0,0,0,.25);
    margin-bottom:6px;
  }
  .clock{font-size:112px; font-weight:900; line-height:1; letter-spacing:.02em; margin:6px 0}
  .phase{font-weight:900; letter-spacing:.08em; text-transform:uppercase; margin-top:6px}

  /* ACTIONS */
  .actions{
    display:flex; flex-direction:column; gap:8px; align-items:center; justify-content:flex-start;
    margin-top:4px;
  }
  .actions .row{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}
  .hint{font-size:12px; opacity:.8}

  /* Settings */
  .settings{background:var(--muted2); border:1px solid var(--border); border-radius:14px; padding:10px 12px}
  h2{margin:4px 0 8px; font-size:16px; text-transform:uppercase; letter-spacing:.07em}
  .block{background:var(--muted); border:1px solid var(--border); border-radius:12px; padding:10px; margin-bottom:8px}
  .digit-grid{display:grid; grid-template-columns:repeat(4, minmax(44px,1fr)); gap:8px; max-width:360px; margin:0 auto}
  .digit-box{display:flex; flex-direction:column; align-items:center; gap:6px}
  .digit{
    width:46px; height:58px; border-radius:10px; border:1px solid var(--border);
    background:var(--muted2); display:grid; place-items:center;
    font-size:26px; font-weight:900; color:var(--fg); cursor:pointer; user-select:none
  }
  .ud{display:flex; gap:6px}
  .ud button{
    width:46px; padding:8px 0; border-radius:10px; background:var(--muted);
    border:1px solid var(--border); color:var(--fg); font-weight:900; font-size:18px; touch-action:manipulation
  }
  .dlabel{font-size:11px; opacity:.8}
  .settings-cta{display:flex; justify-content:center; gap:10px; margin-top:6px}
  .settings-cta .btn{padding:12px 16px; font-size:18px; border-radius:12px; min-width:140px}

  @media (max-width:420px){
    .clock{font-size:96px}
    .btn-xxl{min-width:140px}
    .digit{width:42px; height:54px; font-size:24px}
    .ud button{width:42px; padding:8px 0; font-size:16px}
    .digit-grid{max-width:330px}
    .settings-cta .btn{min-width:128px}
    .rep-big{font-size:64px}
  }

  /* Footer badge (version) */
  .footer{
    position:fixed; bottom:6px; right:8px;
    text-align:right; font-size:12px; opacity:.92;
    padding:6px 8px; background:var(--muted2);
    border:1px solid var(--border); border-radius:8px;
    z-index:5; line-height:1.25;
  }

  /* Help page */
  .helpwrap{ max-width:860px; margin:8px auto 120px; padding:0 8px; }
  .help{ background:var(--muted2); border:1px solid var(--border); border-radius:14px; padding:16px; font-size:14px; line-height:1.5; color:#ddd; }
  .help h3{margin:0 0 8px; font-size:18px}
  .help ul{margin:6px 0 0 18px}
  .help li{margin:4px 0}

  /* Dynamic colors by mode */
  body.mode-work .phase,
  body.mode-work .meta-top{ color:var(--letters-work); }
  body.mode-rest .clock{ color:var(--nums-rest); }
  body.mode-pause .clock{ color:var(--nums-pause); }
  body.mode-pause .pause-banner{ display:block; }

  /* Tiny toast */
  .toast{
    position:fixed; top:56px; left:50%; transform:translateX(-50%);
    background:rgba(0,0,0,.7); padding:10px 14px; border-radius:10px;
    border:1px solid var(--border); color:#fff; font-size:14px; z-index:20; display:none;
  }
  .toast.show{display:block; animation:fade 1.2s ease forwards}
  @keyframes fade{0%{opacity:0; transform:translateX(-50%) translateY(-6px)} 12%{opacity:1; transform:translateX(-50%) translateY(0)} 80%{opacity:1} 100%{opacity:0}}
</style>
</head>
<body class="mode-work">
  <!-- Rising background bar -->
  <div id="progressFull" class="progress-full"></div>

  <div class="app" id="app">
    <!-- VERY TOP: Work/Rest + Stopwatch -->
    <div class="meta-top">
      <span class="meta-tags" id="metaTags">
        <span class="tag">Work <b id="workGoalTop">00:20</b></span>
        <span class="tag">Rest <b id="restGoalTop">00:10</b></span>
      </span>
      <span class="tag stopwatch">
        <span class="icon">⏱️</span><b id="stopwatchText">00:00</b>
      </span>
    </div>

    <!-- TOP-RIGHT: Big REP + info -->
    <div class="top-right">
      <button id="repBtn" class="rep-big" title="Tap: +1 rep • Long-press: reset to 1">1</button>
      <button id="openHelp" class="pill" aria-label="Open instructions">ℹ️</button>
    </div>

    <!-- CONTROLS BAR -->
    <div class="topbar">
      <div class="left" style="display:flex;flex-direction:column;gap:8px;align-items:flex-start;">
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <label class="chip" id="soundChip" title="Toggle all sounds">
            <span>Sound</span>
            <div class="switch">
              <input type="checkbox" id="soundToggle" checked />
              <div class="knob"></div>
            </div>
          </label>
          <label class="chip" id="volChip" title="Volume">
            <span>Vol</span>
            <input id="volume" type="range" min="0" max="100" value="70" />
          </label>
        </div>
        <!-- Settings button (hidden while playing) -->
        <button class="btn btn-settings-big" id="openSettings">⚙️ Settings</button>
      </div>
      <div class="right"></div>
    </div>

    <!-- TIMER SCREEN (MAIN) -->
    <section id="timerScreen" class="screen active">
      <div class="timer" id="timerArea">
        <div class="midwrap">
          <div class="pause-banner" id="pauseBanner">PAUSE</div>
          <div class="clock" id="clock">00:20</div>
          <div class="phase" id="phase">Work</div>
        </div>

        <!-- ACTIONS directly under the numbers -->
        <div class="actions">
          <div class="row">
            <button id="startBtn" class="btn btn-xxl" aria-pressed="false">▶️ Start / Pause</button>
            <button id="resetBtn" class="btn btn-xxl" title="Reset repetitions to 1">⏹ Reset Reps</button>
          </div>
          <div class="hint">Tap anywhere to Start/Pause • Swipe left/right to show/hide top controls</div>
        </div>
      </div>
    </section>

    <!-- SETTINGS SCREEN -->
    <section id="settingsScreen" class="screen">
      <div class="settings">
        <h2>Work</h2>
        <div class="block" id="blockWork">
          <div class="digit-grid" data-kind="work">
            <div class="digit-box" data-role="mt">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">0</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Min (tens)</div>
            </div>
            <div class="digit-box" data-role="mo">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">0</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Min (ones)</div>
            </div>
            <div class="digit-box" data-role="st">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">2</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Sec (tens)</div>
            </div>
            <div class="digit-box" data-role="so">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">0</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Sec (ones)</div>
            </div>
          </div>
        </div>

        <h2>Rest</h2>
        <div class="block" id="blockRest">
          <div class="digit-grid" data-kind="rest">
            <div class="digit-box" data-role="mt">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">0</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Min (tens)</div>
            </div>
            <div class="digit-box" data-role="mo">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">0</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Min (ones)</div>
            </div>
            <div class="digit-box" data-role="st">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">1</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Sec (tens)</div>
            </div>
            <div class="digit-box" data-role="so">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">0</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Sec (ones)</div>
            </div>
          </div>
        </div>

        <div class="settings-cta">
          <button class="btn" id="backToTimer">↩️ Back</button>
          <button class="btn" id="settingsReset" title="Zero times + Reset reps + Reset stopwatch">⏹ Reset</button>
          <button class="btn btn-settings-big" id="toggleSettings">⚙️ Settings</button>
        </div>
        <div class="hint">Reset here: zeros Work/Rest, resets Reps to 1, resets the Stopwatch.</div>
      </div>
    </section>

    <!-- HELP / INSTRUCTIONS -->
    <section id="helpScreen" class="screen">
      <div class="helpwrap">
        <div class="help">
          <h3>How it works</h3>
          <ul>
            <li><b>Tap anywhere</b> on the main timer to Start / Pause / Resume.</li>
            <li><b>Swipe left/right</b> (or click-drag on desktop) to show/hide the top controls.</li>
            <li><b>Playing</b> hides Work/Rest tags, Sound/Vol and Settings; <b>Pause</b> shows them.</li>
            <li>Main <b>Reset Reps</b>: resets reps to 1 and resets the stopwatch.</li>
            <li>Settings <b>Reset</b>: zeros times, resets reps to 1, resets the stopwatch.</li>
            <li>Defaults: <b>Work 0:20</b>, <b>Rest 0:10</b>.</li>
            <li><button class="btn" id="backFromHelp">← Back</button></li>
          </ul>
        </div>
      </div>
    </section>
  </div>

  <!-- Permanent footer badge (bottom-right) -->
  <div class="footer" id="footerBadge">v9</div>

  <!-- Toast -->
  <div id="toast" class="toast">Repetitions reset to 1</div>

<script>
  // ----- Minimal manifest injection for standalone display -----
  (function addManifest(){
    const manifest = {
      "name":"Tabata Timer",
      "short_name":"Tabata",
      "start_url":"./",
      "display":"standalone",
      "theme_color":"#000000",
      "background_color":"#000000",
      "icons":[]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('link');
    link.rel = 'manifest'; link.href = url;
    document.head.appendChild(link);
  })();

  // ----- Try enter fullscreen on first user interaction -----
  let triedFS = false;
  function tryFullscreen(){
    if(triedFS) return; triedFS = true;
    const el = document.documentElement;
    if(el.requestFullscreen){
      el.requestFullscreen().catch(()=>{});
    } else if(el.webkitRequestFullscreen){
      el.webkitRequestFullscreen();
    }
  }
  document.addEventListener('pointerdown', tryFullscreen, {once:true});

  // ----- Utilities -----
  const $ = id => document.getElementById(id);
  const qs = (s, r=document) => r.querySelector(s);
  const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));
  const clamp = (v,min,max) => Math.min(max, Math.max(min, v));
  const pad = n => String(n).padStart(2,'0');
  const fmt = secs => {
    secs = Math.max(0, Math.round(secs));
    const h = Math.floor(secs/3600);
    const m = Math.floor((secs%3600)/60);
    const s = secs%60;
    return h>0 ? `${h}:${pad(m)}:${pad(s)}` : `${pad(m)}:${pad(s)}`;
  };
  const toast = $('toast');
  const showToast = (txt)=>{
    toast.textContent=txt; toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 1200);
  };

  // ----- State (defaults work=20, rest=10) -----
  const state = {
    work: 20, rest: 10,
    phase: 'work',
    running: false,
    startTs: 0,
    elapsed: 0,
    rep: 1,
    muted: false,
    volume: 0.7,
    controlsHidden: false, // user swipe toggle for top controls group

    // Stopwatch (always visible)
    swElapsed: 0,            // seconds accumulated
    swLastStart: 0           // performance.now when last started
  };

  // ----- Persistence -----
  (function load(){
    try{
      const saved = JSON.parse(localStorage.getItem('tabata_v35')||'{}');
      if(Number.isFinite(saved.work)) state.work = saved.work;
      if(Number.isFinite(saved.rest)) state.rest = saved.rest;
      if(typeof saved.muted==='boolean') state.muted = saved.muted;
      if(Number.isFinite(saved.volume)) state.volume = saved.volume;
      if(typeof saved.rep==='number') state.rep = Math.max(1, Math.floor(saved.rep));
      if(typeof saved.controlsHidden==='boolean') state.controlsHidden = saved.controlsHidden;
      if(Number.isFinite(saved.swElapsed)) state.swElapsed = saved.swElapsed;
    }catch{}
  })();
  function persist(){
    localStorage.setItem('tabata_v35', JSON.stringify({
      work:state.work, rest:state.rest, muted:state.muted, volume:state.volume,
      rep:state.rep, controlsHidden:state.controlsHidden, swElapsed:state.swElapsed
    }));
  }

  // ----- Elements -----
  const app = $('app');
  const timerScreen = $('timerScreen');
  const settingsScreen = $('settingsScreen');
  const helpScreen = $('helpScreen');

  const pauseBanner = $('pauseBanner');
  const phaseEl = $('phase');
  const clockEl = $('clock');
  const repBtn = $('repBtn');

  const metaTags = $('metaTags');
  const workGoalTopEl = $('workGoalTop');
  const restGoalTopEl = $('restGoalTop');

  const progressFull = $('progressFull');

  const soundToggle = $('soundToggle');
  const volumeInput = $('volume');
  const soundChip = $('soundChip');
  const volChip = $('volChip');
  const startBtn = $('startBtn');
  const resetBtn = $('resetBtn');

  const openSettingsBtn = $('openSettings');
  const toggleSettingsBtn = $('toggleSettings');
  const stopwatchText = $('stopwatchText');

  // ----- Topbar -----
  soundToggle.checked = !state.muted;
  volumeInput.value = Math.round(state.volume*100);
  soundToggle.addEventListener('change', ()=>{ state.muted = !soundToggle.checked; persist(); });
  volumeInput.addEventListener('input', ()=>{ state.volume = clamp(+volumeInput.value/100,0,1); persist(); });

  // ----- Navigation -----
  $('openHelp').addEventListener('click', ()=> showScreen('help'));
  $('backFromHelp').addEventListener('click', ()=> showScreen('timer'));
  $('backToTimer').addEventListener('click', ()=> showScreen('timer'));

  function onSettingsPressed(){
    if(settingsScreen.classList.contains('active')){
      showScreen('timer');
    } else {
      openSettings();
    }
  }
  openSettingsBtn.addEventListener('click', onSettingsPressed);
  if(toggleSettingsBtn) toggleSettingsBtn.addEventListener('click', onSettingsPressed);

  function showScreen(which){
    const map = {timer:timerScreen, settings:settingsScreen, help:helpScreen};
    for(const [k,sec] of Object.entries(map)){
      if(k===which) sec.classList.add('active'); else sec.classList.remove('active');
    }
    if(which==='settings'){ state.controlsHidden = false; } // ensure controls visible when editing
    updateAllUI();
  }
  function openSettings(){
    pause(); showScreen('settings');
    populateDigits('work', state.work);
    populateDigits('rest', state.rest);
  }

  // ----- Helpers -----
  function secsToParts(s){ s=Math.max(0,Math.round(s)); return {m:Math.floor(s/60), s:s%60}; }
  function partsToSecs(mt,mo,st,so){ let m=mt*10+mo, sec=st*10+so; m=clamp(m,0,59); sec=clamp(sec,0,59); return m*60+sec; }

  function updateMetaTop(){
    const wp=secsToParts(state.work), rp=secsToParts(state.rest);
    workGoalTopEl.textContent = String(pad(wp.m)+':'+pad(wp.s));
    restGoalTopEl.textContent = String(pad(rp.m)+':'+pad(rp.s));
    repBtn.textContent = String(state.rep);
  }

  function updateStartEnabled(){
    const allow = (state.work>0 || state.rest>0);
    startBtn.classList.toggle('disabled', !allow);
    startBtn.disabled = !allow;
  }

  function currentTotal(){ return state.phase==='work' ? state.work : state.rest; }
  function remainingSeconds(){
    const total = currentTotal();
    return Math.max(0, Math.round(total - state.elapsed));
  }

  function setModeClasses(){
    document.body.classList.remove('mode-work','mode-rest','mode-pause');
    if(!state.running && state.elapsed>0){
      document.body.classList.add('mode-pause'); document.body.style.background='var(--bg-pause)';
      pauseBanner.style.display = 'block';
    } else {
      pauseBanner.style.display = 'none';
      if(state.phase==='rest'){
        document.body.classList.add('mode-rest'); document.body.style.background='var(--bg-rest)';
      } else {
        document.body.classList.add('mode-work'); document.body.style.background='var(--bg-work)';
      }
    }
  }

  function updateProgressAndBackground(){
    const total = currentTotal();
    const frac = total>0 ? Math.min(state.elapsed/total, 1) : 1;   // rise from bottom
    const minVH = 6;
    progressFull.style.height = (Math.max(minVH, frac*100)).toFixed(2)+'vh';

    if(state.phase==='work'){
      progressFull.style.background = 'linear-gradient(to top, var(--work1), var(--work2))';
      progressFull.style.boxShadow = '0 -10px 30px rgba(34,197,94,.35)';
    } else {
      progressFull.style.background = 'linear-gradient(to top, var(--rest1), var(--rest2))';
      progressFull.style.boxShadow = '0 -10px 30px rgba(239,68,68,.35)';
    }
  }

  function updateStopwatchUI(){
    // Show live value; if running, preview includes current run segment
    let sw = state.swElapsed;
    if(state.running && state.swLastStart){
      sw += (performance.now() - state.swLastStart)/1000;
    }
    stopwatchText.textContent = fmt(sw);
  }

  // v9: Hide/show top controls based on play/pause
  function updateTopControlsVisibility(){
    const playing = state.running;
    // User swipe toggle still applies, but v9 says: when playing always hide these.
    const shouldHideMeta = playing || state.controlsHidden;
    const shouldHideChips = playing || state.controlsHidden;
    const shouldHideSettingsBtn = playing || state.controlsHidden;

    metaTags.style.display = shouldHideMeta ? 'none' : '';
    soundChip.style.display = shouldHideChips ? 'none' : '';
    volChip.style.display   = shouldHideChips ? 'none' : '';
    openSettingsBtn.style.display = shouldHideSettingsBtn ? 'none' : '';
  }

  function updateAllUI(){
    phaseEl.textContent = state.phase==='work'?'Work':'Rest';
    if(!state.running && state.elapsed>0){
      clockEl.style.color = 'var(--nums-pause)';
    } else if(state.phase==='rest'){
      clockEl.style.color = 'var(--nums-rest)';
    } else {
      clockEl.style.color = 'var(--letters-work)';
    }

    clockEl.textContent = fmt(remainingSeconds());
    updateMetaTop();
    updateProgressAndBackground();
    setModeClasses();

    startBtn.classList.toggle('active', state.running);
    startBtn.setAttribute('aria-pressed', String(state.running));

    updateStopwatchUI();
    updateTopControlsVisibility();
  }

  // init
  updateStartEnabled(); updateAllUI();

  // ----- Digit editor (auto-save) -----
  function populateDigits(kind, secs){
    const grid = qs(`.digit-grid[data-kind="${kind}"]`);
    const {m,s} = secsToParts(secs);
    const mt=Math.floor(m/10), mo=m%10, st=Math.floor(s/10), so=s%10;
    const map={mt,mo,st,so};
    qsa('.digit-box', grid).forEach(box=>{ qs('.digit',box).textContent = map[box.dataset.role]; });
  }
  function readDigits(kind){
    const grid = qs(`.digit-grid[data-kind="${kind}"]`);
    const mt=+qs('[data-role="mt"] .digit',grid).textContent;
    const mo=+qs('[data-role="mo"] .digit',grid).textContent;
    const st=+qs('[data-role="st"] .digit',grid).textContent;
    const so=+qs('[data-role="so"] .digit',grid).textContent;
    return (mt*10+mo)*60 + (st*10+so);
  }
  function commitDigits(kind){
    const secs = readDigits(kind);
    if(kind==='work') state.work = secs; else state.rest = secs;
    persist(); updateMetaTop(); updateStartEnabled(); updateAllUI();
  }
  qsa('.digit-grid').forEach(grid=>{
    grid.addEventListener('click', (e)=>{
      const box = e.target.closest('.digit-box'); if(!box) return;
      const digitEl = qs('.digit', box);

      if(e.target===digitEl){
        const v = prompt('Enter a digit (0–9):', digitEl.textContent);
        if(v==null) return; const d = Number(v.trim());
        if(Number.isInteger(d) && d>=0 && d<=9){
          const role = box.dataset.role;
          const max=(role==='mt'||role==='st')?5:9;
          digitEl.textContent = String(Math.min(max, Math.max(0, d)));
          commitDigits(grid.dataset.kind);
        }
      }
      const actBtn = e.target.closest('button[data-act]');
      if(actBtn){
        const role = box.dataset.role; let cur=+digitEl.textContent; const inc=actBtn.dataset.act==='inc';
        const max=(role==='mt'||role==='st')?5:9, min=0;
        cur = inc?cur+1:cur-1; if(cur>max)cur=min; if(cur<min)cur=max;
        digitEl.textContent=String(cur);
        commitDigits(grid.dataset.kind);
      }
    });
  });

  // ----- Timer engine (Counts down) -----
  let rafId=null;

  function ensureAudio(){
    if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
    if(audioCtx.state==='suspended'){ audioCtx.resume(); }
  }
  function start(){
    if(!(state.work>0 || state.rest>0)) return;
    if(state.running) return;
    ensureAudio();
    state.running=true;
    state.startTs = performance.now() - state.elapsed*1000;
    // start stopwatch segment
    state.swLastStart = performance.now();
    if(state.elapsed===0){ runPhaseTone(); }
    loop();
    updateAllUI();
  }
  function pause(){
    if(!state.running) return;
    state.running=false;
    if(rafId) cancelAnimationFrame(rafId);
    rafId=null;
    // accumulate stopwatch and pause it
    if(state.swLastStart){
      state.swElapsed += (performance.now() - state.swLastStart)/1000;
      state.swLastStart = 0;
      persist();
    }
    updateAllUI();
  }
  function toggleStartPause(){ state.running ? pause() : start(); }

  function restartCurrentPhase(){
    const wasRunning=state.running;
    pause();
    state.elapsed=0;
    state.startTs = performance.now();
    runPhaseTone();
    if(wasRunning) start(); else updateAllUI();
  }
  function nextPhase(){
    const wasRunning=state.running;
    pause();
    if(state.phase==='work'){ state.phase='rest'; }
    else { state.phase='work'; state.rep += 1; }
    state.elapsed=0;
    state.startTs = performance.now();
    runPhaseTone();
    persist();
    if(wasRunning) start(); else updateAllUI();
  }
  function switchPhaseAuto(){
    if(state.phase==='work'){ state.phase='rest'; }
    else { state.phase='work'; state.rep += 1; persist(); }
    state.elapsed=0; state.startTs=performance.now();
    runPhaseTone(); updateAllUI();
  }

  function loop(){
    if(!state.running) return;
    const total = currentTotal();
    const now = performance.now();
    state.elapsed = Math.max(0, (now - state.startTs)/1000);

    // live stopwatch preview (fast update)
    updateStopwatchUI();

    if(state.elapsed >= total){ switchPhaseAuto(); state.startTs = performance.now(); }
    updateAllUI();
    rafId = requestAnimationFrame(loop);
  }

  // Buttons
  startBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleStartPause(); });

  // MAIN Reset button: reset all repetitions to 1 + restart current phase + reset stopwatch
  function doResetReps(){
    state.rep = 1;
    state.swElapsed = 0;
    if(state.running){
      state.swLastStart = performance.now();
    } else {
      state.swLastStart = 0;
    }
    persist();
    restartCurrentPhase();
    showToast('Repetitions reset to 1 • Stopwatch reset');
  }
  resetBtn.addEventListener('click', (e)=>{ e.stopPropagation(); doResetReps(); });

  // Anywhere taps on main timer (single-tap = toggle start/pause)
  let tapCount = 0, tapTimer = null;
  function commitTapActions(){
    const c = tapCount; tapCount=0; clearTimeout(tapTimer); tapTimer=null;
    if(c===1){ toggleStartPause(); }
  }
  timerScreen.addEventListener('pointerdown', (e)=>{
    if(e.target.closest('button, input, label, .digit, .ud button, .settings, .chip')) return;
    tapCount+=1;
    if(tapTimer) clearTimeout(tapTimer);
    tapTimer=setTimeout(commitTapActions, 280);
  });

  // Swipe to toggle visibility of the top controls group (user preference)
  let swipeStartX=0, swipeStartY=0, swiping=false;
  const SWIPE_THRESH = 60;   // px horizontal
  const TAP_SLOP = 12;       // ignore tiny jitters
  function onPointerDown(e){
    if(e.target.closest('button, input, label, .digit, .ud button, .settings, .chip')) return;
    swipeStartX = e.clientX; swipeStartY = e.clientY; swiping = true;
  }
  function onPointerMove(e){
    if(!swiping) return;
    const dx = e.clientX - swipeStartX;
    const dy = e.clientY - swipeStartY;
    if(Math.abs(dx) > SWIPE_THRESH && Math.abs(dx) > Math.abs(dy)+TAP_SLOP){
      swiping = false;
      state.controlsHidden = !state.controlsHidden;
      persist(); updateAllUI();
    }
  }
  function onPointerUp(){ swiping=false; }
  timerScreen.addEventListener('pointerdown', onPointerDown);
  timerScreen.addEventListener('pointermove', onPointerMove);
  timerScreen.addEventListener('pointerup', onPointerUp);
  timerScreen.addEventListener('pointercancel', onPointerUp);
  timerScreen.addEventListener('pointerleave', onPointerUp);

  // REP button
  let repPressTimer=null; let repPressed=false;
  repBtn.addEventListener('pointerdown', ()=>{
    repPressed=true;
    repPressTimer = setTimeout(()=>{
      if(repPressed){ state.rep=1; persist(); updateAllUI(); showToast('Repetitions reset to 1'); }
    }, 500);
  });
  repBtn.addEventListener('pointerup', ()=>{
    if(repPressTimer){ clearTimeout(repPressTimer); repPressTimer=null; }
    if(repPressed){ state.rep+=1; persist(); updateAllUI(); }
    repPressed=false;
  });
  repBtn.addEventListener('pointerleave', ()=>{
    repPressed=false;
    if(repPressTimer){ clearTimeout(repPressTimer); repPressTimer=null; }
  });

  // Keyboard: any key toggles start/pause (except when editing / in settings/help)
  document.addEventListener('keydown', (e)=>{
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toUpperCase() : '';
    if(tag==='INPUT' || tag==='TEXTAREA' || e.target.isContentEditable) return;
    if(settingsScreen.classList.contains('active') || helpScreen.classList.contains('active')) return;
    toggleStartPause();
  });

  // Audio
  const HALF_OCT = Math.SQRT2;
  let audioCtx=null;
  function beep(freq=440, dur=0.3, t0){
    if(state.muted) return 0;
    if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
    const ctx=audioCtx;
    if(ctx.state==='suspended') ctx.resume();
    const now = t0 ?? ctx.currentTime;
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.type='sine';
    osc.frequency.value=freq;
    gain.gain.setValueAtTime(0, now);
    gain.gain.linearRampToValueAtTime(state.volume*0.75, now+0.015);
    gain.gain.exponentialRampToValueAtTime(0.0001, now+dur);
    osc.connect(gain).connect(ctx.destination);
    osc.start(now);
    osc.stop(now+dur+0.02);
    return dur;
  }
  function workTone(){ const base = 440 * HALF_OCT; beep(base, 0.5); }
  function restTone(){
    const start = audioCtx ? audioCtx.currentTime : 0;
    const hi = 784 * HALF_OCT;          // ~1108 Hz
    const lo = 523 * HALF_OCT;          // ~739 Hz
    const d1 = beep(hi, 0.3, start || undefined);
    beep(lo, 0.3, (start||0) + d1 + 0.06);
  }
  function runPhaseTone(){ if(state.muted) return; (state.phase==='work') ? workTone() : restTone(); }

  // Settings Reset: zero times + reset reps to 1 + reset stopwatch
  $('settingsReset').addEventListener('click', ()=>{
    pause();
    state.work = 0; state.rest = 0;
    state.rep = 1;
    state.swElapsed = 0;
    state.swLastStart = 0;
    persist();
    populateDigits('work', state.work);
    populateDigits('rest', state.rest);
    updateMetaTop(); updateStartEnabled(); updateAllUI();
    showToast('Times zeroed • Reps reset • Stopwatch reset');
  });

  // Initial draw (ensure top controls reflect defaults)
  (function initDraw(){
    // set initial meta labels (0:20 / 0:10)
    updateMetaTop();
    // set initial clock for Work
    clockEl.textContent = fmt(state.work);
    // progress bar base
    const total = currentTotal();
    const frac = total>0 ? Math.min(state.elapsed/total, 1) : 0;
    progressFull.style.height = (Math.max(6, frac*100)).toFixed(2)+'vh';
    updateStopwatchUI();
    updateAllUI();
  })();

  // (Optional) Keep screen awake on mobile if supported
  if ('wakeLock' in navigator) {
    let wl;
    const req = async ()=>{ try{ wl = await navigator.wakeLock.request('screen'); }catch{} };
    req();
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') req(); });
  }
</script>
</body>
</html>
