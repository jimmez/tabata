<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Tabata Timer v19</title>

<!-- PWA-ish -->
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<style>
  :root{
    --bg-work:#000;         /* page bg when WORK */
    --bg-rest:#8b1e5d;      /* page bg when REST */
    --bg-pause:#87ceeb;     /* page bg when PAUSED */

    --fg:#fff;
    --border:#23252b;
    --muted:rgba(255,255,255,.08);
    --muted2:rgba(255,255,255,.04);

    /* Text colors per mode */
    --letters-work:#60a5fa;  /* light blue labels (work) */
    --nums-rest:#facc15;     /* yellow numbers (rest) */
    --nums-pause:#a855f7;    /* purple numbers (pause) */

    /* Rising bar colors */
    --work1: rgba(34,197,94,.95);  /* green */
    --work2: rgba(34,197,94,.65);
    --rest1: rgba(239,68,68,.95);  /* red */
    --rest2: rgba(239,68,68,.65);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--fg);
    font-family:Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial;
    -webkit-tap-highlight-color:transparent;
    background:var(--bg-work);
    transition:background .18s ease;
    overflow-x:hidden;
  }

  /* Rising background bar (behind content) */
  .progress-full{
    position:fixed; left:0; right:0; bottom:0; z-index:0;
    height:6vh; /* starts small and rises toward full screen */
    background:linear-gradient(to top, var(--work1), var(--work2));
    box-shadow:0 -10px 30px rgba(34,197,94,.30);
    pointer-events:none;
    transition:background .12s ease, box-shadow .12s ease, height .15s linear;
  }

  /* TOP-LEFT live device clock — same size as stopwatch */
  .live-clock{
    position:fixed; top:8px; left:8px; z-index:12;
    font-size:32px;
    font-weight:1000; letter-spacing:.02em;
    background:var(--muted2); border:1px solid var(--border);
    padding:8px 14px; border-radius:999px;
  }
  @media (max-width:420px){ .live-clock{font-size:29px} }

  /* Info pill moved to the left side, under the live clock */
  .info-left{
    position:fixed; top:52px; left:8px; z-index:12;
    background:var(--muted2); color:#bbb; border:1px solid var(--border);
    border-radius:999px; padding:6px 10px; font-size:12px; font-weight:800; cursor:pointer; user-select:none;
  }
  .info-left:active{transform:translateY(1px)}

  /* TOP-CENTER STOPWATCH */
  .stopwatch-top{
    position:fixed; top:8px; left:50%; transform:translateX(-50%);
    z-index:12;
    font-size:32px;
    font-weight:1000; letter-spacing:.02em;
    background:var(--muted2); border:1px solid var(--border);
    padding:8px 14px; border-radius:999px;
  }
  @media (max-width:420px){ .stopwatch-top{font-size:29px} }

  /* Settings-only Top Back button (shows only while .in-settings) */
  .settings-back-top{
    position:fixed; top:8px; right:8px; z-index:13;
    display:none;
    border:1px solid var(--border);
    background:var(--muted2); color:#fff;
    font-weight:900; font-size:14px;
    padding:10px 12px; border-radius:12px; cursor:pointer;
  }
  body.in-settings .settings-back-top{ display:inline-flex; }

  .app{
    position:relative; z-index:1; max-width:820px; margin:0 auto;
    min-height:100%; display:flex; flex-direction:column;
    padding:60px 12px 92px; /* keep clear of fixed top chips */
    gap:0;
  }

  /* Fixed-height header so clock never shifts vertically */
  .header{
    height:44px; display:flex; align-items:center; gap:10px;
    font-size:12px; color:#bbb; opacity:.95; padding:2px 0;
  }
  .tag{
    background:var(--muted2); border:1px solid var(--border);
    border-radius:999px; padding:6px 10px; display:flex; align-items:center; gap:6px;
  }
  .workrest{display:flex; gap:8px; align-items:center;}
  .workrest.hidden{visibility:hidden;} /* reserve space, no layout shift */

  /* Rep pinned top-right — responsive size */
  .top-right{
    position:fixed; top:6px; right:8px; z-index:11; display:flex; align-items:center; gap:8px;
  }
  .rep-big{
    background:transparent; border:none; color:#fff; cursor:pointer; user-select:none;
    font-weight:1000; line-height:1; letter-spacing:.02em;
    font-size:58px; /* base */
    text-shadow:0 2px 10px rgba(0,0,0,.35);
  }
  /* If 3+ digits, shrink more to avoid overlapping stopwatch */
  .rep-big[data-len="3"]{ font-size:46px; }
  .rep-big[data-len="4"]{ font-size:40px; }
  /* Portrait-specific tighter cap */
  @media (orientation:portrait){
    .rep-big{ font-size:54px; }
    .rep-big[data-len="3"]{ font-size:42px; }
    .rep-big[data-len="4"]{ font-size:36px; }
  }

  /* Center stage */
  .midwrap{
    flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
    text-align:center; padding:0 6px;
  }

  /* Row with back / clock / forward (back+fwd only visible when paused) */
  .clockRow{
    display:flex; align-items:center; gap:14px;
  }
  .clock{font-size:112px; font-weight:900; line-height:1; letter-spacing:.02em; margin:6px 0}

  /* Pause-only nav buttons beside the clock */
  .nav-btn{
    display:none; /* shown in pause via JS */
    border:1px solid var(--border);
    background:var(--muted2);
    color:inherit;
    font-weight:900; font-size:18px;
    padding:10px 12px; border-radius:12px; cursor:pointer;
    user-select:none;
  }
  .nav-btn:active{transform:translateY(1px)}
  body.mode-work .nav-btn { background: rgba(96,165,250,0.16); }  /* light blue */
  body.mode-rest .nav-btn { background: rgba(250,204,21,0.16); }  /* yellow */
  body.mode-pause .nav-btn{ background: rgba(168,85,247,0.16); }  /* purple */

  .phase{font-weight:900; letter-spacing:.08em; text-transform:uppercase; margin-top:10px}

  /* Pause banner BELOW the timer (no shifting) */
  .pause-banner{
    margin-top:10px;
    font-size:36px; font-weight:1000; letter-spacing:.12em;
    text-transform:uppercase; color:var(--nums-pause);
    text-shadow:0 2px 14px rgba(0,0,0,.25);
    display:none;
  }

  /* Bottom controls & settings (below the numbers) */
  .bottom{
    display:flex; flex-direction:column; gap:12px; align-items:center; margin:10px 0 0;
  }
  .row{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
  .chip{
    display:inline-flex; align-items:center; gap:8px; padding:8px 12px;
    background:var(--muted2); border:1px solid var(--border); border-radius:999px; font-size:14px
  }
  .switch{position:relative; width:56px; height:32px; background:#333; border:1px solid var(--border); border-radius:999px; cursor:pointer}
  .switch input{display:none}
  .knob{position:absolute; top:2px; left:2px; width:28px; height:28px; border-radius:50%; background:#777; transition:all .18s ease}
  .switch input:checked + .knob{left:26px; background:#34d399}
  input[type="range"]{accent-color:#34d399}

  .btn{
    appearance:none; border:1px solid var(--border);
    background:var(--muted); color:rgba(255,255,255,.85);
    padding:12px 16px; border-radius:14px; font-weight:800; cursor:pointer; touch-action:manipulation;
    box-shadow:none;
  }
  .btn:hover{background:var(--muted2)}
  .btn:active{transform:translateY(1px)}
  .btn-xxl{font-size:22px; padding:14px 18px; border-radius:16px; min-width:150px}
  .btn.disabled{opacity:.45; filter:grayscale(.2); cursor:not-allowed}

  .settings{background:var(--muted2); border:1px solid var(--border); border-radius:14px; padding:10px 12px; width:100%; max-width:860px; max-height:48vh; overflow:auto;}
  h2{margin:4px 0 8px; font-size:16px; text-transform:uppercase; letter-spacing:.07em}
  .block{background:var(--muted); border:1px solid var(--border); border-radius:12px; padding:10px; margin-bottom:8px}
  .digit-grid{display:grid; grid-template-columns:repeat(4, minmax(44px,1fr)); gap:8px; max-width:360px; margin:0 auto}
  .digit-box{display:flex; flex-direction:column; align-items:center; gap:6px}
  .digit{
    width:46px; height:58px; border-radius:10px; border:1px solid var(--border);
    background:var(--muted2); display:grid; place-items:center;
    font-size:26px; font-weight:900; color:var(--fg); cursor:pointer; user-select:none
  }
  .ud{display:flex; gap:6px}
  .ud button{
    width:46px; padding:8px 0; border-radius:10px; background:var(--muted);
    border:1px solid var(--border); color:var(--fg); font-weight:900; font-size:18px; touch-action:manipulation
  }
  .dlabel{font-size:11px; opacity:.8}

  .settings-cta{display:flex; justify-content:center; gap:10px; margin-top:6px}
  .settings-cta .btn{padding:12px 16px; font-size:18px; border-radius:12px; min-width:140px}

  @media (max-width:420px){
    .clock{font-size:96px}
    .btn-xxl{min-width:140px}
    .digit{width:42px; height:54px; font-size:24px}
    .ud button{width:42px; padding:8px 0; font-size:16px}
    .digit-grid{max-width:330px}
    .settings-cta .btn{min-width:128px}
    .pause-banner{font-size:32px}
  }

  /* Footer badge (version) — only version */
  .footer{
    position:fixed; bottom:6px; right:8px;
    text-align:right; font-size:12px; opacity:.92;
    padding:6px 8px; background:var(--muted2);
    border:1px solid var(--border); border-radius:8px;
    z-index:5; line-height:1.25;
  }

  /* Transient bottom message */
  .transient{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:10px; z-index:6;
    background:var(--muted2); border:1px solid var(--border); color:#fff;
    padding:8px 12px; border-radius:10px; font-size:14px;
    opacity:0; pointer-events:none; transition:opacity .25s ease;
  }
  .transient.show{opacity:1}

  /* Help page */
  .helpwrap{ max-width:860px; margin:8px auto 120px; padding:0 8px; }
  .help{ background:var(--muted2); border:1px solid var(--border); border-radius:14px; padding:16px; font-size:14px; line-height:1.5; color:#ddd; }
  .help h3{margin:0 0 8px; font-size:18px}
  .help ul{margin:6px 0 0 18px}
  .help li{margin:4px 0}

  /* Dynamic colors by mode */
  body.mode-work .phase,
  body.mode-work .header{ color:var(--letters-work); }
  body.mode-rest .clock{ color:var(--nums-rest); }
  body.mode-pause .clock{ color:var(--nums-pause); }
  body.mode-pause .pause-banner{ display:block; }

  /* Hide most controls while in-settings for more space */
  body.in-settings #actionRow,
  body.in-settings #audioRow,
  body.in-settings .nav-btn { display:none !important; }
</style>
</head>
<body class="mode-work">
  <!-- Rising background bar -->
  <div id="progressFull" class="progress-full"></div>

  <!-- TOP-LEFT LIVE CLOCK -->
  <div class="live-clock" id="liveClock">00:00</div>

  <!-- INFO on left -->
  <button id="openHelpLeft" class="info-left" aria-label="Open instructions">ℹ️</button>

  <!-- TOP-CENTER STOPWATCH -->
  <div class="stopwatch-top" id="stopwatchText">00:00</div>

  <!-- SETTINGS top-only back (visible only while in-settings) -->
  <button id="settingsBackTop" class="settings-back-top" title="Back to Timer">← Back</button>

  <div class="app" id="app">
    <!-- Fixed-height header (reserves space; no clock shift) -->
    <div class="header">
      <span class="workrest" id="workRestHeader">
        <span class="tag">Work <b id="workGoalTop">00:20</b></span>
        <span class="tag">Rest <b id="restGoalTop">00:10</b></span>
      </span>
    </div>

    <!-- TOP-RIGHT: Big REP -->
    <div class="top-right">
      <button id="repBtn" class="rep-big" title="Tap: +1 rep • Long-press: reset to 1">1</button>
    </div>

    <!-- CLOCK AREA -->
    <div class="midwrap" id="timerArea">
      <div class="clockRow">
        <button id="backBtn" class="nav-btn" title="Back">⏪</button>
        <div class="clock" id="clock">00:20</div>
        <button id="fwdBtn" class="nav-btn" title="Forward">⏩</button>
      </div>
      <div class="phase" id="phase">Work</div>
      <div class="pause-banner" id="pauseBanner">PAUSE</div>
    </div>

    <!-- BOTTOM: actions + settings (below the numbers) -->
    <div class="bottom">
      <!-- Actions -->
      <div class="row" id="actionRow">
        <button id="startBtn" class="btn btn-xxl" aria-pressed="false">▶️ Start / Pause</button>
        <button id="resetBtn" class="btn btn-xxl" title="Reset repetitions to 1 • Go to Work">⏹ Reset Reps</button>
        <button class="btn btn-xxl" id="openSettings">⚙️ Settings</button>
      </div>

      <!-- Sound & Volume -->
      <div class="row" id="audioRow">
        <label class="chip" id="soundChip" title="Toggle all sounds">
          <span>Sound</span>
          <div class="switch">
            <input type="checkbox" id="soundToggle" checked />
            <div class="knob"></div>
          </div>
        </label>
        <label class="chip" id="volChip" title="Volume">
          <span>Vol</span>
          <input id="volume" type="range" min="0" max="100" value="70" />
        </label>
      </div>

      <!-- Settings (inline below) -->
      <div class="settings" id="settingsBlock" hidden>
        <h2>Work</h2>
        <div class="block" id="blockWork">
          <div class="digit-grid" data-kind="work">
            <div class="digit-box" data-role="mt">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">0</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Min (tens)</div>
            </div>
            <div class="digit-box" data-role="mo">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">0</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Min (ones)</div>
            </div>
            <div class="digit-box" data-role="st">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">2</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Sec (tens)</div>
            </div>
            <div class="digit-box" data-role="so">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">0</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Sec (ones)</div>
            </div>
          </div>
        </div>

        <h2>Rest</h2>
        <div class="block" id="blockRest">
          <div class="digit-grid" data-kind="rest">
            <div class="digit-box" data-role="mt">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">0</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Min (tens)</div>
            </div>
            <div class="digit-box" data-role="mo">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">0</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Min (ones)</div>
            </div>
            <div class="digit-box" data-role="st">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">1</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Sec (tens)</div>
            </div>
            <div class="digit-box" data-role="so">
              <div class="ud"><button data-act="inc">＋</button></div>
              <div class="digit" tabindex="0">0</div>
              <div class="ud"><button data-act="dec">－</button></div>
              <div class="dlabel">Sec (ones)</div>
            </div>
          </div>
        </div>

        <!-- Sounds -->
        <h2>Sounds</h2>
        <div class="block">
          <div class="dlabel" style="margin-bottom:8px">
            Choose a style. Default keeps: <b>Work = 1 beep</b>, <b>Rest = 2 beeps</b> (two pitches).
          </div>
          <label class="chip" style="gap:12px;">
            <span>Theme</span>
            <select id="soundTheme">
              <option value="beep">Beep (default)</option>
              <option value="doorbell">Doorbell (two tones)</option>
              <option value="flute">Flute-like</option>
              <option value="chime">Chime</option>
              <option value="click">Click</option>
            </select>
          </label>
        </div>

        <div class="settings-cta">
          <button class="btn" id="settingsClose">↩️ Back</button>
          <button class="btn" id="settingsReset" title="Zero times + Reset reps + Reset stopwatch">⏹ Reset</button>
        </div>
        <div class="dlabel" style="text-align:center; margin-top:6px;">Changes auto-save. Scroll for more.</div>
      </div>
    </div>

    <!-- HELP / INSTRUCTIONS -->
    <section id="helpScreen" class="screen" style="display:none;">
      <div class="helpwrap">
        <div class="help">
          <h3>How it works</h3>
          <ul>
            <li><b>Tap anywhere</b> on the main timer to Start / Pause / Resume.</li>
            <li>Controls live <b>below</b> the numbers so the countdown never shifts.</li>
            <li><b>Playing</b> hides Settings/Sound/Volume and Start/Reset; <b>Pause</b> shows them.</li>
            <li>Reset Reps: resets reps to 1, resets stopwatch, and switches to <b>Work</b>.</li>
            <li>Settings Reset: zeros times, resets reps to 1, resets the stopwatch.</li>
            <li>Defaults: <b>Work 0:20</b>, <b>Rest 0:10</b>.</li>
            <li><button class="btn" id="backFromHelp">← Back</button></li>
          </ul>
        </div>
      </div>
    </section>
  </div>

  <!-- Version badge -->
  <div class="footer" id="footerBadge">v19</div>

  <!-- Transient bottom note (5s) -->
  <div class="transient" id="jjTransient">Jimmy James – 02.10.2025</div>

<script>
  // ---- Minimal manifest for standalone ----
  (function addManifest(){
    const manifest = {
      name:"Tabata Timer", short_name:"Tabata", start_url:"./", display:"standalone",
      theme_color:"#000000", background_color:"#000000", icons:[]
    };
    const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
  })();

  // ---- Fullscreen on first interaction ----
  let triedFS=false;
  function tryFS(){ if(triedFS) return; triedFS=true;
    const el=document.documentElement;
    (el.requestFullscreen?.bind(el) || el.webkitRequestFullscreen?.bind(el) || (()=>Promise.resolve()))().catch(()=>{});
  }
  document.addEventListener('pointerdown', tryFS, {once:true});

  // ---- Utils ----
  const $ = id => document.getElementById(id);
  const qs = (s, r=document) => r.querySelector(s);
  const qsa = (s, r=document) => Array.from(r.querySelectorAll(s));
  const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));
  const pad = n => String(n).padStart(2,'0');
  const fmt = secs => { secs=Math.max(0,Math.round(secs));
    const h=Math.floor(secs/3600), m=Math.floor((secs%3600)/60), s=secs%60;
    return h>0 ? `${h}:${pad(m)}:${pad(s)}` : `${pad(m)}:${pad(s)}`; };

  // ---- Live 24h device clock (HH:MM) ----
  function fmtHHMM(d){ return `${pad(d.getHours())}:${pad(d.getMinutes())}`; }
  function tickLiveClock(){ $('liveClock').textContent = fmtHHMM(new Date()); }
  setInterval(tickLiveClock, 1000); tickLiveClock();

  // ---- Transient credit 5s ----
  (function showJJ(){
    const el = $('jjTransient');
    el.classList.add('show');
    setTimeout(()=>{ el.classList.remove('show'); el.style.display='none'; }, 5000);
  })();

  // ---- State (defaults 20/10) ----
  const state = {
    work:20, rest:10,
    phase:'work',
    running:false,
    startTs:0, elapsed:0,
    rep:1,
    muted:false, volume:0.7,
    soundTheme:'beep',
    // Stopwatch
    swElapsed:0, swLastStart:0
  };

  // ---- Persistence ----
  (function load(){
    try{
      const saved = JSON.parse(localStorage.getItem('tabata_v38')||'{}');
      for(const k of ['work','rest','rep','muted','volume','swElapsed','soundTheme']){
        if(saved[k]!==undefined){
          if(k==='muted') state[k]=!!saved[k];
          else if(k==='volume') state[k]=+saved[k];
          else state[k]= (k==='soundTheme') ? String(saved[k]) : +saved[k];
        }
      }
    }catch{}
  })();
  function persist(){
    localStorage.setItem('tabata_v38', JSON.stringify({
      work:state.work, rest:state.rest, rep:state.rep,
      muted:state.muted, volume:state.volume, swElapsed:state.swElapsed,
      soundTheme:state.soundTheme
    }));
  }

  // ---- Elements ----
  const progressFull = $('progressFull');
  const workRestHeader = $('workRestHeader');
  const workGoalTopEl = $('workGoalTop');
  const restGoalTopEl = $('restGoalTop');
  const stopwatchText = $('stopwatchText');
  const liveClock = $('liveClock');

  const pauseBanner = $('pauseBanner');
  const clockEl = $('clock');
  const phaseEl = $('phase');
  const repBtn = $('repBtn');

  const startBtn = $('startBtn');
  const resetBtn = $('resetBtn');
  const openSettingsBtn = $('openSettings');
  const settingsBlock = $('settingsBlock');
  const settingsClose = $('settingsClose'); // kept, but we'll also support the fixed top back
  const settingsBackTop = $('settingsBackTop');
  const settingsReset = $('settingsReset');

  const soundToggle = $('soundToggle');
  const volumeInput = $('volume');
  const soundThemeSel = $('soundTheme');

  const backBtn = $('backBtn');
  const fwdBtn  = $('fwdBtn');

  // Info (left)
  const openHelpLeft = $('openHelpLeft');

  // ---- Audio toggles ----
  soundToggle.checked = !state.muted;
  volumeInput.value = Math.round(state.volume*100);
  soundThemeSel.value = state.soundTheme;
  soundToggle.addEventListener('change', ()=>{ state.muted = !soundToggle.checked; persist(); });
  volumeInput.addEventListener('input', ()=>{ state.volume = clamp(+volumeInput.value/100,0,1); persist(); });
  soundThemeSel.addEventListener('change', ()=>{ state.soundTheme = soundThemeSel.value; persist(); });

  // ---- Helpers ----
  function secsToParts(s){ s=Math.max(0,Math.round(s)); return {m:Math.floor(s/60), s:s%60}; }
  function updateHeader(){
    const wp=secsToParts(state.work), rp=secsToParts(state.rest);
    workGoalTopEl.textContent = `${pad(wp.m)}:${pad(wp.s)}`;
    restGoalTopEl.textContent = `${pad(rp.m)}:${pad(rp.s)}`;
    repBtn.textContent = String(state.rep);
    repBtn.setAttribute('data-len', String(state.rep).length);
  }
  function currentTotal(){ return state.phase==='work' ? state.work : state.rest; }
  function remainingSeconds(){ return Math.max(0, Math.round(currentTotal() - state.elapsed)); }

  function setModeClasses(){
    document.body.classList.remove('mode-work','mode-rest','mode-pause');
    if(!state.running && state.elapsed>0){
      document.body.classList.add('mode-pause'); document.body.style.background='var(--bg-pause)';
      pauseBanner.style.display='block';
    } else {
      pauseBanner.style.display='none';
      if(state.phase==='rest'){ document.body.classList.add('mode-rest'); document.body.style.background='var(--bg-rest)'; }
      else { document.body.classList.add('mode-work'); document.body.style.background='var(--bg-work)'; }
    }
  }

  function syncColors(){
    const col = getComputedStyle(clockEl).color;
    stopwatchText.style.color = col;
    repBtn.style.color = col;
    liveClock.style.color = col;
  }

  function updateProgress(){
    const total=currentTotal();
    const frac = total>0 ? Math.min(state.elapsed/total,1) : 1;
    const minVH=6;
    progressFull.style.height = (Math.max(minVH, frac*100)).toFixed(2)+'vh';
    if(state.phase==='work'){
      progressFull.style.background='linear-gradient(to top, var(--work1), var(--work2))';
      progressFull.style.boxShadow='0 -10px 30px rgba(34,197,94,.35)';
    }else{
      progressFull.style.background='linear-gradient(to top, var(--rest1), var(--rest2))';
      progressFull.style.boxShadow='0 -10px 30px rgba(239,68,68,.35)';
    }
  }
  function updateStopwatch(){
    let sw = state.swElapsed;
    if(state.running && state.swLastStart){ sw += (performance.now()-state.swLastStart)/1000; }
    stopwatchText.textContent = fmt(sw);
  }
  function updatePlayPauseVisibility(){
    const playing = state.running;

    // header tags hidden while playing
    workRestHeader.classList.toggle('hidden', playing);

    // bottom rows hidden while playing OR while settings open
    const inSettings = document.body.classList.contains('in-settings');
    $('actionRow').style.display = (playing || inSettings) ? 'none' : '';
    $('audioRow').style.display  = (playing || inSettings) ? 'none' : '';

    // pause-only nav buttons
    const showNav = (!state.running) && !inSettings;
    backBtn.style.display = showNav ? 'inline-flex' : 'none';
    fwdBtn.style.display  = showNav ? 'inline-flex' : 'none';
  }
  function updateAllUI(){
    phaseEl.textContent = state.phase==='work'?'Work':'Rest';
    clockEl.textContent = fmt(remainingSeconds());

    if(!state.running && state.elapsed>0)      clockEl.style.color='var(--nums-pause)';
    else if(state.phase==='rest')              clockEl.style.color='var(--nums-rest)';
    else                                       clockEl.style.color='var(--letters-work)';

    updateHeader();
    updateProgress();
    setModeClasses();
    updateStopwatch();
    updatePlayPauseVisibility();
    syncColors();

    startBtn.classList.toggle('active', state.running);
    startBtn.setAttribute('aria-pressed', String(state.running));
  }

  // ---- Digits editor (auto-save) ----
  function populateDigits(kind, secs){
    const grid = qs(`.digit-grid[data-kind="${kind}"]`);
    const {m,s} = secsToParts(secs);
    const mt=Math.floor(m/10), mo=m%10, st=Math.floor(s/10), so=s%10;
    const map={mt,mo,st,so};
    qsa('.digit-box',grid).forEach(b=>{ qs('.digit',b).textContent = map[b.dataset.role]; });
  }
  function readDigits(kind){
    const grid = qs(`.digit-grid[data-kind="${kind}"]`);
    const mt=+qs('[data-role="mt"] .digit',grid).textContent;
    const mo=+qs('[data-role="mo"] .digit',grid).textContent;
    const st=+qs('[data-role="st"] .digit',grid).textContent;
    const so=+qs('[data-role="so"] .digit',grid).textContent;
    return (mt*10+mo)*60 + (st*10+so);
  }
  function commitDigits(kind){
    const secs = readDigits(kind);
    if(kind==='work') state.work = secs; else state.rest = secs;
    persist(); updateHeader(); updateAllUI();
  }
  qsa('.digit-grid').forEach(grid=>{
    grid.addEventListener('click', (e)=>{
      const box = e.target.closest('.digit-box'); if(!box) return;
      const digitEl = qs('.digit', box);

      if(e.target===digitEl){
        const v = prompt('Enter a digit (0–9):', digitEl.textContent);
        if(v==null) return; const d=Number(v.trim());
        if(Number.isInteger(d) && d>=0 && d<=9){
          const role=box.dataset.role; const max=(role==='mt'||role==='st')?5:9;
          digitEl.textContent = String(Math.min(max, Math.max(0,d)));
          commitDigits(grid.dataset.kind);
        }
      }
      const act = e.target.closest('button[data-act]');
      if(act){
        const role=box.dataset.role; let cur=+digitEl.textContent; const inc=act.dataset.act==='inc';
        const max=(role==='mt'||role==='st')?5:9, min=0;
        cur = inc?cur+1:cur-1; if(cur>max)cur=min; if(cur<min)cur=max;
        digitEl.textContent=String(cur);
        commitDigits(grid.dataset.kind);
      }
    });
  });

  // ---- Timer engine ----
  let rafId=null;
  let audioCtx=null;
  const HALF_OCT = Math.SQRT2; // defined ONCE

  function ensureAudio(){
    if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
    if(audioCtx.state==='suspended'){ audioCtx.resume(); }
  }

  // Short noise buffer (for "click" theme)
  let noiseBuffer=null;
  function getNoiseBuffer(ctx){
    if(noiseBuffer) return noiseBuffer;
    const len = 0.02*ctx.sampleRate; // 20 ms
    const buf = ctx.createBuffer(1, len, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for(let i=0;i<len;i++){ data[i] = (Math.random()*2-1) * Math.exp(-i/(len*0.6)); }
    noiseBuffer = buf; return buf;
  }

  // Tone helpers
  function oscBeep(freq=440, dur=0.3, type='sine', gainScale=1, t0){
    if(state.muted) return 0;
    if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
    const ctx=audioCtx;
    if(ctx.state==='suspended') ctx.resume();
    const now = t0 ?? ctx.currentTime;
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    osc.type=type;
    osc.frequency.setValueAtTime(freq, now);
    const peak = state.volume * 0.8 * gainScale;
    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(Math.max(0.0002, peak), now+0.02);
    gain.gain.exponentialRampToValueAtTime(0.0001, now+dur);
    osc.connect(gain).connect(ctx.destination);
    osc.start(now);
    osc.stop(now+dur+0.02);
    return dur;
  }
  function chime(freq=880, dur=0.5, t0){
    if(state.muted) return 0;
    const ctx=audioCtx||(audioCtx=new (window.AudioContext||window.webkitAudioContext)());
    const now=t0??ctx.currentTime;
    const o1=ctx.createOscillator(), o2=ctx.createOscillator();
    const g=ctx.createGain();
    o1.type='sine'; o2.type='sine';
    o1.frequency.setValueAtTime(freq, now);
    o2.frequency.setValueAtTime(freq*1.5, now);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(state.volume*0.6, now+0.03);
    g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
    o1.connect(g); o2.connect(g); g.connect(ctx.destination);
    o1.start(now); o2.start(now);
    o1.stop(now+dur+0.02); o2.stop(now+dur+0.02);
    return dur;
  }
  function fluteLike(freq=660, dur=0.5, t0){
    if(state.muted) return 0;
    const ctx=audioCtx||(audioCtx=new (window.AudioContext||window.webkitAudioContext)());
    const now=t0??ctx.currentTime;
    const osc=ctx.createOscillator(), vibr=ctx.createOscillator();
    const g=ctx.createGain(), vg=ctx.createGain();
    osc.type='triangle'; vibr.type='sine';
    osc.frequency.setValueAtTime(freq, now);
    vibr.frequency.setValueAtTime(6, now);
    vg.gain.setValueAtTime(5, now);
    vibr.connect(vg).connect(osc.frequency);
    g.gain.setValueAtTime(0.0001, now);
    g.gain.linearRampToValueAtTime(state.volume*0.6, now+0.08);
    g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
    osc.connect(g).connect(ctx.destination);
    osc.start(now); vibr.start(now);
    osc.stop(now+dur+0.02); vibr.stop(now+dur+0.02);
    return dur;
  }
  function clickSound(t0){
    if(state.muted) return 0;
    const ctx=audioCtx||(audioCtx=new (window.AudioContext||window.webkitAudioContext)());
    const now=t0??ctx.currentTime;
    const src=ctx.createBufferSource(); src.buffer=getNoiseBuffer(ctx);
    const g=ctx.createGain(); g.gain.value=state.volume;
    src.connect(g).connect(ctx.destination);
    src.start(now); src.stop(now+0.02);
    return 0.02;
  }

  // Theme-aware cues (Work=1, Rest=2 @ two pitches)
  function cueWork(){
    ensureAudio();
    const th = state.soundTheme;
    if(th==='flute') { fluteLike(660*HALF_OCT, 0.5); return; }
    if(th==='chime') { chime(880*HALF_OCT, 0.5); return; }
    if(th==='click') { clickSound(); return; }
    if(th==='doorbell'){ oscBeep(880*HALF_OCT, 0.45, 'sine', 1.0); return; }
    oscBeep(440*HALF_OCT, 0.5, 'sine', 1.0);
  }
  function cueRest(){
    ensureAudio();
    const th = state.soundTheme, ctx=audioCtx;
    if(th==='flute'){ const t=ctx.currentTime, d1=fluteLike(784*HALF_OCT,.3,t); fluteLike(523*HALF_OCT,.3,t+d1+.06); return; }
    if(th==='chime'){ const t=ctx.currentTime, d1=chime(660*HALF_OCT,.28,t); chime(440*HALF_OCT,.28,t+d1+.06); return; }
    if(th==='click'){ const t=ctx.currentTime, d1=clickSound(t); clickSound(t+d1+.06); return; }
    if(th==='doorbell'){ const t=ctx.currentTime, d1=oscBeep(784*HALF_OCT,.3,'sine',1.0,t); oscBeep(523*HALF_OCT,.3,'sine',1.0,t+d1+.06); return; }
    const t=ctx.currentTime, d1=oscBeep(784*HALF_OCT,.3,'sine',1.0,t); oscBeep(523*HALF_OCT,.3,'sine',1.0,t+d1+.06);
  }
  function runPhaseTone(){ if(state.muted) return; (state.phase==='work') ? cueWork() : cueRest(); }

  // Engine
  function start(){
    if(!(state.work>0 || state.rest>0)) return;
    if(state.running) return;
    ensureAudio();
    state.running=true;
    state.startTs = performance.now() - state.elapsed*1000;
    state.swLastStart = performance.now();
    if(state.elapsed===0){ runPhaseTone(); }
    loop(); updateAllUI();
  }
  function pause(){
    if(!state.running) return;
    state.running=false;
    if(rafId) cancelAnimationFrame(rafId); rafId=null;
    if(state.swLastStart){
      state.swElapsed += (performance.now()-state.swLastStart)/1000;
      state.swLastStart=0; persist();
    }
    updateAllUI();
  }
  function toggleStartPause(){ state.running?pause():start(); }

  function restartCurrentPhasePaused(){
    state.running=false;
    state.elapsed=0;
    state.startTs=performance.now();
    updateAllUI();
  }

  function switchPhaseToPaused(newPhase, opts={}){
    if(newPhase==='work' && state.phase==='rest' && opts.incRep){
      state.rep += 1;
    }
    state.phase = newPhase;
    state.elapsed = 0;
    state.startTs = performance.now();
    persist();
    updateAllUI();
  }

  function nextPhaseAuto(){
    if(state.phase==='work') state.phase='rest';
    else { state.phase='work'; state.rep+=1; persist(); }
    state.elapsed=0; state.startTs=performance.now(); runPhaseTone(); updateAllUI();
  }

  function loop(){
    if(!state.running) return;
    const total=currentTotal();
    const now=performance.now();
    state.elapsed = Math.max(0,(now-state.startTs)/1000);

    updateStopwatch();
    if(state.elapsed>=total){ nextPhaseAuto(); state.startTs=performance.now(); }
    updateAllUI();
    rafId=requestAnimationFrame(loop);
  }

  // ---- Main interactions ----
  // Tap anywhere in timer area: Start/Pause/Resume
  let tapCount=0, tapTimer=null;
  function commitTap(){ const c=tapCount; tapCount=0; clearTimeout(tapTimer); tapTimer=null; if(c===1) toggleStartPause(); }
  $('timerArea').addEventListener('pointerdown', (e)=>{
    if(document.body.classList.contains('in-settings')) return; // disable main tap while in settings
    if(e.target.closest('button, input, label, .digit, .ud button, .settings')) return;
    tapCount+=1; if(tapTimer) clearTimeout(tapTimer); tapTimer=setTimeout(commitTap, 250);
  });

  // Start / Reset
  startBtn.addEventListener('click', (e)=>{ e.stopPropagation(); toggleStartPause(); });
  resetBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    state.rep=1;
    state.swElapsed=0; // stopwatch reset
    state.swLastStart = state.running?performance.now():0;
    state.phase='work'; // go to Work
    persist();
    restartCurrentPhasePaused();
    showToast('Reps reset • Stopwatch reset • Set to Work');
  });

  // Settings open/close (top-only back while open)
  function openSettings(){
    pause(); // ensure we stay paused
    settingsBlock.hidden=false;
    document.body.classList.add('in-settings');
    populateDigits('work',state.work); populateDigits('rest',state.rest);
    updateAllUI();
  }
  function closeSettings(){
    settingsBlock.hidden=true;
    document.body.classList.remove('in-settings');
    // remain paused when returning
    updateAllUI();
  }
  openSettingsBtn.addEventListener('click', openSettings);
  settingsClose.addEventListener('click', closeSettings);
  settingsBackTop.addEventListener('click', closeSettings);

  // Help
  openHelpLeft.addEventListener('click', ()=>{ $('helpScreen').style.display='block'; });
  $('backFromHelp').addEventListener('click', ()=>{ $('helpScreen').style.display='none'; });

  // Rep button (+1 tap, long-press reset to 1)
  let repPressTimer=null, repPressed=false;
  repBtn.addEventListener('pointerdown', ()=>{
    repPressed=true;
    repPressTimer=setTimeout(()=>{ if(repPressed){ state.rep=1; persist(); updateAllUI(); showToast('Repetitions reset to 1'); } }, 500);
  });
  repBtn.addEventListener('pointerup', ()=>{
    if(repPressTimer){ clearTimeout(repPressTimer); repPressTimer=null; }
    if(repPressed){ state.rep+=1; persist(); updateAllUI(); }
    repPressed=false;
  });
  repBtn.addEventListener('pointerleave', ()=>{ repPressed=false; if(repPressTimer){ clearTimeout(repPressTimer); repPressTimer=null; } });

  // Keyboard: any key toggles start/pause (unless typing or help/settings open)
  document.addEventListener('keydown', (e)=>{
    const tag=(e.target&&e.target.tagName)?e.target.tagName.toUpperCase():'';
    if(tag==='INPUT'||tag==='TEXTAREA'||e.target.isContentEditable) return;
    if($('helpScreen').style.display==='block') return;
    if(document.body.classList.contains('in-settings')) return;
    toggleStartPause();
  });

  // Settings Reset: zero times + reset reps + reset stopwatch (stays paused on Work)
  settingsReset.addEventListener('click', ()=>{
    pause(); state.work=0; state.rest=0; state.rep=1; state.swElapsed=0; state.swLastStart=0; state.phase='work'; persist();
    populateDigits('work',state.work); populateDigits('rest',state.rest); updateHeader(); updateAllUI();
    showToast('Times zeroed • Reps reset • Stopwatch reset • Set to Work');
  });

  // ---- Pause-only navigation behavior ----
  backBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    if(state.running || document.body.classList.contains('in-settings')) return;

    if(state.phase==='work'){
      restartCurrentPhasePaused();
    } else {
      if(state.elapsed>0){
        restartCurrentPhasePaused();
      } else {
        switchPhaseToPaused('work', {incRep:false});
      }
    }
  });

  fwdBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    if(state.running || document.body.classList.contains('in-settings')) return;

    if(state.phase==='work'){
      switchPhaseToPaused('rest', {incRep:false});
    } else {
      switchPhaseToPaused('work', {incRep:true});
    }
  });

  // ---- Initial draw ----
  (function init(){
    updateHeader();
    clockEl.textContent = fmt(state.work);
    const total=currentTotal(), frac = total>0?Math.min(state.elapsed/total,1):0;
    progressFull.style.height=(Math.max(6,frac*100)).toFixed(2)+'vh';
    updateStopwatch(); updateAllUI();
  })();

  // Keep screen awake (if supported)
  if('wakeLock' in navigator){ let wl; const req=async()=>{try{wl=await navigator.wakeLock.request('screen');}catch{}}; req(); document.addEventListener('visibilitychange',()=>{ if(document.visibilityState==='visible') req(); }); }
</script>
</body>
</html>
